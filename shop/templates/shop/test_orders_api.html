<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API –∑–∞–º–æ–≤–ª–µ–Ω—å</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .json-display {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .loading { 
            display: none; 
        }
        .timing-info { 
            background-color: #e3f2fd; 
            padding: 15px; 
            border-radius: 8px; 
            margin-top: 15px;
            border-left: 4px solid #2196f3;
        }
        .api-card {
            margin-bottom: 2rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .cache-hit {
            color: #28a745;
            font-weight: bold;
        }
        .cache-miss {
            color: #dc3545;
            font-weight: bold;
        }
        .test-section {
            border-left: 3px solid #007bff;
            padding-left: 15px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{% url 'index' %}">–ú–∞–≥–∞–∑–∏–Ω</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{% url 'stuff_list' %}">–¢–æ–≤–∞—Ä–∏</a>
                {% if user.is_authenticated %}
                    <a class="nav-link" href="{% url 'view_cart' %}">–ö–æ—à–∏–∫</a>
                    <a class="nav-link" href="{% url 'orders_page' %}">–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</a>
                {% endif %}
                <a class="nav-link" href="{% url 'index' %}">–ì–æ–ª–æ–≤–Ω–∞</a>
            </div>
        </div>
    </nav>


    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">üîç –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è API —Ç–∞ –∫–µ—à—É–≤–∞–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω—å</h1>

                <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
                {% if user.is_authenticated %}
                <div class="alert alert-info">
                    <strong>üë§ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á:</strong> {{ user.username }} (ID: {{ user.id }})
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è –£–≤–∞–≥–∞:</strong> –ù–µ–æ–±—Ö—ñ–¥–Ω–æ <a href="{% url 'login' %}">—É–≤—ñ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a> –¥–ª—è —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è API
                </div>
                {% endif %}

                <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Å—Ç–∞–º–∏ -->
                <div class="card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">üéõÔ∏è –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ç–µ—Å—Ç–∞–º–∏</h5>
                    </div>
                    <div class="card-body">
                        <button id="run-all-tests" class="btn btn-primary me-2">
                            <span class="spinner-border spinner-border-sm me-2 loading"></span>
                            –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –≤—Å—ñ —Ç–µ—Å—Ç–∏
                        </button>
                        <button id="clear-all-tests" class="btn btn-outline-secondary">
                            –û—á–∏—Å—Ç–∏—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏
                        </button>
                    </div>
                </div>

                <!-- API: –°–ø–∏—Å–æ–∫ –∑–∞–º–æ–≤–ª–µ–Ω—å -->
                <div class="card api-card">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üìã GET /api/orders/ - API –∑–∞–º–æ–≤–ª–µ–Ω—å</h5>
                            <button id="test-orders-api" class="btn btn-light btn-sm">
                                <span class="loading spinner-border spinner-border-sm me-2"></span>
                                –¢–µ—Å—Ç—É–≤–∞—Ç–∏ API
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="orders-api-results">
                            <p class="text-muted">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–¢–µ—Å—Ç—É–≤–∞—Ç–∏ API" –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏</p>
                        </div>
                    </div>
                </div>

                <!-- –ö–µ—à–æ–≤–∞–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞ -->
                <div class="card api-card">
                    <div class="card-header bg-warning text-dark">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">üåê GET /orders/ - –ö–µ—à–æ–≤–∞–Ω–∞ —Å—Ç–æ—Ä—ñ–Ω–∫–∞</h5>
                            <div>
                                <button id="test-orders-page" class="btn btn-dark btn-sm me-2">
                                    <span class="loading spinner-border spinner-border-sm me-2"></span>
                                    –¢–µ—Å—Ç –∫–µ—à—É
                                </button>
                                <a href="{% url 'orders_page' %}" class="btn btn-outline-dark btn-sm" target="_blank">
                                    –í—ñ–¥–∫—Ä–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="orders-page-results">
                            <p class="text-muted">–¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –∫–µ—à—É–≤–∞–Ω–Ω—è –ø–æ–≤–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (@cache_page)</p>
                        </div>
                    </div>
                </div>

                <!-- –ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π —Ç–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ -->
                <div class="card api-card">
                    <div class="card-header bg-info text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">‚ö° –ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π —Ç–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ</h5>
                            <button id="speed-test" class="btn btn-light btn-sm">
                                <span class="loading spinner-border spinner-border-sm me-2"></span>
                                –ó–∞–ø—É—Å—Ç–∏—Ç–∏ —Ç–µ—Å—Ç
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="speed-results">
                            <p class="text-muted">–ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è —à–≤–∏–¥–∫–æ—Å—Ç—ñ API vs –∫–µ—à–æ–≤–∞–Ω–∏—Ö —Å—Ç–æ—Ä—ñ–Ω–æ–∫</p>
                        </div>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç—ñ–≤ -->
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">üìä –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
                    </div>
                    <div class="card-body">
                        <div id="test-statistics">
                            <p class="text-muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑'—è–≤–∏—Ç—å—Å—è –ø—ñ—Å–ª—è –∑–∞–ø—É—Å–∫—É —Ç–µ—Å—Ç—ñ–≤</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        let testStats = {
            totalTests: 0,
            successfulTests: 0,
            apiResponseTimes: [],
            pageResponseTimes: []
        };

        // –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        function formatTime(ms) {
            if (ms < 1000) return `${Math.round(ms)} –º—Å`;
            return `${(ms / 1000).toFixed(2)} —Å`;
        }

        function showLoading(buttonId, show = true) {
            const button = document.getElementById(buttonId);
            const loading = button.querySelector('.loading');
            if (loading) {
                loading.style.display = show ? 'inline-block' : 'none';
            }
            button.disabled = show;
        }

        async function timedFetch(url) {
            const startTime = performance.now();
            try {
                const response = await fetch(url);
                const endTime = performance.now();
                const responseTime = endTime - startTime;
                
                const text = await response.text();
                let data = null;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    // –Ø–∫—â–æ –Ω–µ JSON, –∑–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å—Ç–∏–Ω—É HTML
                    data = { html_content: text.substring(0, 200) + '...' };
                }
                
                return {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText,
                    data: data,
                    responseTime: responseTime,
                    size: text.length,
                    error: response.ok ? null : text
                };
            } catch (error) {
                const endTime = performance.now();
                return {
                    success: false,
                    status: 0,
                    statusText: 'Network Error',
                    data: null,
                    responseTime: endTime - startTime,
                    size: 0,
                    error: error.message
                };
            }
        }

        function updateStatistics() {
            const container = document.getElementById('test-statistics');
            const successRate = testStats.totalTests > 0 ? 
                (testStats.successfulTests / testStats.totalTests * 100).toFixed(1) : 0;
                
            const avgApiTime = testStats.apiResponseTimes.length > 0 ?
                testStats.apiResponseTimes.reduce((a, b) => a + b, 0) / testStats.apiResponseTimes.length : 0;
                
            const avgPageTime = testStats.pageResponseTimes.length > 0 ?
                testStats.pageResponseTimes.reduce((a, b) => a + b, 0) / testStats.pageResponseTimes.length : 0;

            container.innerHTML = `
                <div class="timing-info">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>üìà –í—Å—å–æ–≥–æ —Ç–µ—Å—Ç—ñ–≤:</strong><br>
                            <span class="fs-4">${testStats.totalTests}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>‚úÖ –£—Å–ø—ñ—à–Ω–∏—Ö:</strong><br>
                            <span class="fs-4 text-success">${testStats.successfulTests}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>üìä –£—Å–ø—ñ—à–Ω—ñ—Å—Ç—å:</strong><br>
                            <span class="fs-4">${successRate}%</span>
                        </div>
                        <div class="col-md-3">
                            <strong>‚ö° –°–µ—Ä–µ–¥–Ω—ñ–π —á–∞—Å:</strong><br>
                            API: ${formatTime(avgApiTime)}<br>
                            –°—Ç–æ—Ä—ñ–Ω–∫–∏: ${formatTime(avgPageTime)}
                        </div>
                    </div>
                </div>
            `;
        }

        // –¢–µ—Å—Ç API –∑–∞–º–æ–≤–ª–µ–Ω—å
        document.getElementById('test-orders-api').addEventListener('click', async () => {
            showLoading('test-orders-api', true);
            const container = document.getElementById('orders-api-results');
            
            container.innerHTML = '<p class="text-info">‚è≥ –í–∏–∫–æ–Ω—É—î–º–æ –∑–∞–ø–∏—Ç –¥–æ /api/orders/...</p>';
            
            const result = await timedFetch('/api/orders/');
            testStats.totalTests++;
            
            if (result.success) {
                testStats.successfulTests++;
                testStats.apiResponseTimes.push(result.responseTime);
            }

            let html = `
                <div class="timing-info">
                    <strong>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç API –∑–∞–ø–∏—Ç—É:</strong><br>
                    –°—Ç–∞—Ç—É—Å: <span class="badge bg-${result.success ? 'success' : 'danger'}">${result.status} ${result.statusText}</span><br>
                    –ß–∞—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: <strong>${formatTime(result.responseTime)}</strong><br>
                    –†–æ–∑–º—ñ—Ä –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ: ${result.size} –±–∞–π—Ç
                </div>
            `;
            
            if (result.success && result.data) {
                const dataCount = Array.isArray(result.data) ? result.data.length : 
                    (result.data.order_history ? result.data.order_history.length : '–Ω–µ–≤—ñ–¥–æ–º–æ');
                html += `
                    <div class="mt-3">
                        <h6>üìã –ó–Ω–∞–π–¥–µ–Ω–æ –∑–∞–ø–∏—Å—ñ–≤: ${dataCount}</h6>
                        <div class="json-display">${JSON.stringify(result.data, null, 2)}</div>
                    </div>
                `;
            } else {
                html += `
                    <div class="alert alert-danger mt-3">
                        <strong>‚ùå –ü–æ–º–∏–ª–∫–∞:</strong> ${result.error}
                    </div>
                `;
            }
            
            container.innerHTML = html;
            updateStatistics();
            showLoading('test-orders-api', false);
        });

        // –¢–µ—Å—Ç –∫–µ—à–æ–≤–∞–Ω–æ—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏
        document.getElementById('test-orders-page').addEventListener('click', async () => {
            showLoading('test-orders-page', true);
            const container = document.getElementById('orders-page-results');
            
            container.innerHTML = '<p class="text-info">‚è≥ –¢–µ—Å—Ç—É—î–º–æ –∫–µ—à—É–≤–∞–Ω–Ω—è —Å—Ç–æ—Ä—ñ–Ω–∫–∏...</p>';
            
            // –û—á–∏—â—É—î–º–æ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è —á–∏—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç—É
            const cacheBuster = '?t=' + Date.now();
            
            const result1 = await timedFetch('/orders/' + cacheBuster);
            await new Promise(resolve => setTimeout(resolve, 200));
            const result2 = await timedFetch('/orders/');
            
            testStats.totalTests += 2;
            if (result1.success) {
                testStats.successfulTests++;
                testStats.pageResponseTimes.push(result1.responseTime);
            }
            if (result2.success) {
                testStats.successfulTests++;
                testStats.pageResponseTimes.push(result2.responseTime);
            }

            const speedImprovement = result1.responseTime / result2.responseTime;
            const isCacheHit = speedImprovement > 1.2;
            
            let html = `
                <div class="timing-info">
                    <strong>üåê –¢–µ—Å—Ç –∫–µ—à—É–≤–∞–Ω–Ω—è @cache_page:</strong><br>
                    –ü–µ—Ä—à–∏–π –∑–∞–ø–∏—Ç: <strong>${formatTime(result1.responseTime)}</strong><br>
                    –ü–æ–≤—Ç–æ—Ä–Ω–∏–π –∑–∞–ø–∏—Ç: <strong>${formatTime(result2.responseTime)}</strong><br>
                    –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è: <strong>${speedImprovement.toFixed(1)}x</strong><br>
                    –°—Ç–∞—Ç—É—Å –∫–µ—à—É: <span class="${isCacheHit ? 'cache-hit' : 'cache-miss'}">
                        ${isCacheHit ? '‚úÖ –ö–µ—à –ø—Ä–∞—Ü—é—î –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ!' : '‚ö†Ô∏è –ö–µ—à –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ'}
                    </span>
                </div>
            `;
            
            container.innerHTML = html;
            updateStatistics();
            showLoading('test-orders-page', false);
        });

        // –ö–æ–º–ø–ª–µ–∫—Å–Ω–∏–π —Ç–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ
        document.getElementById('speed-test').addEventListener('click', async () => {
            showLoading('speed-test', true);
            const container = document.getElementById('speed-results');
            
            container.innerHTML = '<p class="text-info">‚ö° –ó–∞–ø—É—Å–∫–∞—î–º–æ –∫–æ–º–ø–ª–µ–∫—Å–Ω–∏–π —Ç–µ—Å—Ç —à–≤–∏–¥–∫–æ—Å—Ç—ñ...</p>';
            
            const tests = [
                { name: 'API –∑–∞–º–æ–≤–ª–µ–Ω—å', url: '/api/orders/', type: 'api' },
                { name: '–°—Ç–æ—Ä—ñ–Ω–∫–∞ –∑–∞–º–æ–≤–ª–µ–Ω—å', url: '/orders/', type: 'page' }
            ];
            
            let html = '<div class="timing-info"><strong>‚ö° –†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–≥–æ —Ç–µ—Å—Ç—É:</strong><br><br>';
            
            for (const test of tests) {
                container.innerHTML = `<p class="text-info">‚ö° –¢–µ—Å—Ç—É—î–º–æ: ${test.name}...</p>`;
                
                const times = [];
                for (let i = 0; i < 3; i++) {
                    const result = await timedFetch(test.url + (i === 0 ? '?t=' + Date.now() : ''));
                    testStats.totalTests++;
                    
                    if (result.success) {
                        testStats.successfulTests++;
                        times.push(result.responseTime);
                        
                        if (test.type === 'api') {
                            testStats.apiResponseTimes.push(result.responseTime);
                        } else {
                            testStats.pageResponseTimes.push(result.responseTime);
                        }
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                if (times.length > 0) {
                    const min = Math.min(...times);
                    const max = Math.max(...times);
                    const avg = times.reduce((a, b) => a + b, 0) / times.length;
                    const speedup = times[0] / times[times.length - 1];
                    
                    html += `
                        <div class="test-section">
                            <strong>${test.name}:</strong><br>
                            ‚Ä¢ –ù–∞–π—à–≤–∏–¥—à–∏–π: ${formatTime(min)}<br>
                            ‚Ä¢ –ù–∞–π–ø–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π: ${formatTime(max)}<br>
                            ‚Ä¢ –°–µ—Ä–µ–¥–Ω—ñ–π: ${formatTime(avg)}<br>
                            ‚Ä¢ –ü—Ä–∏—Å–∫–æ—Ä–µ–Ω–Ω—è: ${speedup.toFixed(1)}x<br>
                        </div>
                    `;
                }
            }
            
            html += '</div>';
            container.innerHTML = html;
            updateStatistics();
            showLoading('speed-test', false);
        });

        // –ó–∞–ø—É—Å–∫ –≤—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤
        document.getElementById('run-all-tests').addEventListener('click', async () => {
            showLoading('run-all-tests', true);
            
            // –ó–∞–ø—É—Å–∫–∞—î–º–æ –≤—Å—ñ —Ç–µ—Å—Ç–∏ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ
            document.getElementById('test-orders-api').click();
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            document.getElementById('test-orders-page').click();
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            document.getElementById('speed-test').click();
            await new Promise(resolve => setTimeout(resolve, 3000));
            
            showLoading('run-all-tests', false);
        });

        // –û—á–∏—Å—Ç–∫–∞ –≤—Å—ñ—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
        document.getElementById('clear-all-tests').addEventListener('click', () => {
            document.getElementById('orders-api-results').innerHTML = '<p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ</p>';
            document.getElementById('orders-page-results').innerHTML = '<p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ</p>';
            document.getElementById('speed-results').innerHTML = '<p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –æ—á–∏—â–µ–Ω–æ</p>';
            document.getElementById('test-statistics').innerHTML = '<p class="text-muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–∏—â–µ–Ω–∞</p>';
            
            // –°–∫–∏–¥–∞—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            testStats = {
                totalTests: 0,
                successfulTests: 0,
                apiResponseTimes: [],
                pageResponseTimes: []
            };
        });
    </script>
</body>
</html>
